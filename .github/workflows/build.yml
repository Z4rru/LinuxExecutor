name: Build and Release OSS Executor

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build git pkg-config \
            libgtk-4-dev libcurl4-openssl-dev libssl-dev \
            libgirepository1.0-dev luajit libluajit-5.1-dev \
            libspdlog-dev nlohmann-json3-dev \
            fonts-jetbrains-mono

      - name: Configure
        working-directory: oss-executor
        run: |
          mkdir -p build && cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr

      - name: Build
        working-directory: oss-executor/build
        run: |
          ninja -j$(nproc) 2>&1 | tee build.log
          BUILD_EXIT=${PIPESTATUS[0]}
          if [ $BUILD_EXIT -ne 0 ]; then
            echo ""
            echo "══════════════════════════════════════════"
            echo "  BUILD FAILED — Last 80 lines of output:"
            echo "══════════════════════════════════════════"
            tail -80 build.log
            exit 1
          fi

      - name: Package
        run: |
          mkdir -p package/oss-executor

          cp oss-executor/build/OSSExecutor package/oss-executor/
          cp -r oss-executor/scripts  package/oss-executor/ 2>/dev/null || true
          cp -r oss-executor/themes   package/oss-executor/ 2>/dev/null || true
          cp -r oss-executor/resources package/oss-executor/ 2>/dev/null || true
          cp oss-executor/config.json package/oss-executor/ 2>/dev/null || true
          cp oss-executor/run.sh      package/oss-executor/ 2>/dev/null || true
          cp README.md               package/oss-executor/ 2>/dev/null || true

          chmod +x package/oss-executor/OSSExecutor
          [ -f package/oss-executor/run.sh ] && chmod +x package/oss-executor/run.sh

          cat > package/oss-executor/install.sh << 'INSTALL_EOF'
          #!/bin/bash
          set -e
          echo "Installing OSS Executor..."
          mkdir -p ~/.oss-executor/{scripts/autoexec,themes,logs,workspace,cache}
          cp -r scripts/* ~/.oss-executor/scripts/ 2>/dev/null || true
          cp -r themes/* ~/.oss-executor/themes/ 2>/dev/null || true
          cp -r resources ~/.oss-executor/ 2>/dev/null || true
          cp config.json ~/.oss-executor/ 2>/dev/null || true
          sudo cp OSSExecutor /usr/local/bin/oss-executor
          echo "Installed! Run with: oss-executor"
          INSTALL_EOF
          chmod +x package/oss-executor/install.sh

          cd package
          tar -czf oss-executor-linux-x86_64.tar.gz oss-executor/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oss-executor-linux-x86_64
          path: package/oss-executor-linux-x86_64.tar.gz

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: package/oss-executor-linux-x86_64.tar.gz
          body: |
            ## OSS Executor ${{ github.ref_name }}

            ### tar.gz Install
            ```bash
            tar -xzf oss-executor-linux-x86_64.tar.gz
            cd oss-executor && ./install.sh
            ```

            ### AppImage
            ```bash
            chmod +x OSS_Executor-x86_64.AppImage
            ./OSS_Executor-x86_64.AppImage
            ```
          draft: false
          prerelease: false

  build-appimage:
    runs-on: ubuntu-22.04
    needs: []
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build pkg-config \
            libgtk-4-dev libcurl4-openssl-dev libssl-dev \
            luajit libluajit-5.1-dev \
            libspdlog-dev nlohmann-json3-dev \
            wget file patchelf imagemagick

      - name: Build
        working-directory: oss-executor
        run: |
          mkdir -p build && cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          ninja -j$(nproc) 2>&1 | tee build.log
          BUILD_EXIT=${PIPESTATUS[0]}
          if [ $BUILD_EXIT -ne 0 ]; then
            echo "BUILD FAILED:"; tail -80 build.log; exit 1
          fi

      - name: Prepare icon
        run: |
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          ICON_DST="AppDir/usr/share/icons/hicolor/256x256/apps/oss-executor.png"
          ICON_SRC="oss-executor/resources/icons/logo.png"
          ICON_OK=false

          if [ -f "$ICON_SRC" ] && [ -s "$ICON_SRC" ]; then
            if file "$ICON_SRC" | grep -qi "PNG image"; then
              cp "$ICON_SRC" "$ICON_DST"
              ICON_OK=true
              echo "✓ Using project logo.png"
            fi
          fi

          if [ "$ICON_OK" = false ]; then
            echo "⚠ Generating fallback icon..."
            convert -size 256x256 xc:'#6e40c9' \
              -fill white -gravity center \
              -font Helvetica -pointsize 80 \
              -annotate 0 "OSS" \
              "png:${ICON_DST}" 2>/dev/null \
            || convert -size 256x256 xc:'#6e40c9' "png:${ICON_DST}" 2>/dev/null \
            || python3 -c "
          import struct, zlib
          def png(w,h):
              def chunk(t,d):
                  c=t+d; return struct.pack('>I',len(d))+c+struct.pack('>I',zlib.crc32(c)&0xffffffff)
              raw=b''
              for y in range(h):
                  raw+=b'\x00'+b'\x6e\x40\xc9\xff'*w
              return b'\x89PNG\r\n\x1a\n'+chunk(b'IHDR',struct.pack('>IIBBBBB',w,h,8,6,0,0,0))+chunk(b'IDAT',zlib.compress(raw))+chunk(b'IEND',b'')
          with open('$ICON_DST','wb') as f: f.write(png(256,256))
          "
          fi

          echo "Icon size: $(wc -c < "$ICON_DST") bytes"
          file "$ICON_DST"

      - name: Create AppImage
        run: |
          wget -q "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
          chmod +x linuxdeploy-x86_64.AppImage

          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/oss-executor

          cp oss-executor/build/OSSExecutor AppDir/usr/bin/
          cp -r oss-executor/scripts oss-executor/themes \
                oss-executor/resources oss-executor/config.json \
                AppDir/usr/share/oss-executor/ 2>/dev/null || true

          cat > AppDir/usr/share/applications/oss-executor.desktop << 'DESKTOP_EOF'
          [Desktop Entry]
          Type=Application
          Name=OSS Executor
          Comment=Open Source Lua Script Executor
          Exec=OSSExecutor
          Icon=oss-executor
          Categories=Development;
          Terminal=false
          DESKTOP_EOF

          cat > AppDir/AppRun << 'APPRUN_EOF'
          #!/usr/bin/env bash
          SELF="$(readlink -f "$0")"
          HERE="$(dirname "$SELF")"
          export GIO_MODULE_DIR=""
          export GIO_USE_VFS="local"
          export GSK_RENDERER="${GSK_RENDERER:-gl}"
          export GTK_A11Y=none
          export NO_AT_BRIDGE=1
          if [ -z "${DBUS_SESSION_BUS_ADDRESS:-}" ]; then
            export DBUS_SESSION_BUS_ADDRESS="disabled:"
          fi
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH:-}"
          export OSS_HOME="${HOME}/.oss-executor"
          exec "${HERE}/usr/bin/OSSExecutor" "$@"
          APPRUN_EOF
          chmod +x AppDir/AppRun

          export APPIMAGE_EXTRACT_AND_RUN=1
          export OUTPUT="OSS_Executor-x86_64.AppImage"

          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --output appimage \
            --desktop-file AppDir/usr/share/applications/oss-executor.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/oss-executor.png

      - name: Verify AppImage
        run: |
          ls -lh OSS_Executor-x86_64.AppImage
          file OSS_Executor-x86_64.AppImage

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: oss-executor-AppImage
          path: "OSS_Executor-x86_64.AppImage"
          if-no-files-found: warn

      - name: Attach AppImage to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: "OSS_Executor-x86_64.AppImage"
