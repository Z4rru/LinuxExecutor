name: Build and Release OSS Executor

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build git pkg-config \
            libgtk-4-dev libcurl4-openssl-dev libssl-dev \
            libgirepository1.0-dev luajit libluajit-5.1-dev \
            libspdlog-dev nlohmann-json3-dev \
            fonts-jetbrains-mono

      - name: Configure
        working-directory: oss-executor
        run: |
          mkdir -p build && cd build
          cmake .. \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=/usr

      - name: Build
        working-directory: oss-executor/build
        run: ninja -j$(nproc)

      - name: Package
        run: |
          mkdir -p package/oss-executor

          cp oss-executor/build/OSSExecutor package/oss-executor/
          cp -r oss-executor/scripts  package/oss-executor/
          cp -r oss-executor/themes   package/oss-executor/
          cp -r oss-executor/resources package/oss-executor/
          cp oss-executor/config.json package/oss-executor/
          cp oss-executor/run.sh      package/oss-executor/
          cp oss-executor/build.sh    package/oss-executor/
          cp README.md               package/oss-executor/ 2>/dev/null || true

          chmod +x package/oss-executor/OSSExecutor
          chmod +x package/oss-executor/run.sh

          # install.sh — heredoc at column 0 to avoid leading whitespace
          cat > package/oss-executor/install.sh << 'INSTALL_EOF'
          #!/bin/bash
          set -e
          echo "Installing OSS Executor..."
          mkdir -p ~/.oss-executor/{scripts/autoexec,themes,logs,workspace,cache}
          cp -r scripts/* ~/.oss-executor/scripts/ 2>/dev/null || true
          cp -r themes/* ~/.oss-executor/themes/ 2>/dev/null || true
          cp -r resources ~/.oss-executor/ 2>/dev/null || true
          cp config.json ~/.oss-executor/ 2>/dev/null || true
          sudo cp OSSExecutor /usr/local/bin/oss-executor
          echo "Installed! Run with: oss-executor"
          INSTALL_EOF
          chmod +x package/oss-executor/install.sh

          cd package
          tar -czf oss-executor-linux-x86_64.tar.gz oss-executor/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oss-executor-linux-x86_64
          path: package/oss-executor-linux-x86_64.tar.gz

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: package/oss-executor-linux-x86_64.tar.gz
          body: |
            ## OSS Executor ${{ github.ref_name }}

            ### tar.gz Install
            ```bash
            tar -xzf oss-executor-linux-x86_64.tar.gz
            cd oss-executor && ./install.sh
            ```

            ### Or run directly
            ```bash
            tar -xzf oss-executor-linux-x86_64.tar.gz
            cd oss-executor && ./run.sh
            ```

            ### AppImage
            ```bash
            chmod +x OSS_Executor-x86_64.AppImage
            ./OSS_Executor-x86_64.AppImage
            ```
            If FUSE is unavailable:
            ```bash
            ./OSS_Executor-x86_64.AppImage --appimage-extract-and-run
            ```
          draft: false
          prerelease: false

  build-appimage:
    runs-on: ubuntu-22.04
    # ═══════════════════════════════════════════════════════
    # Removed `needs: build-linux` — jobs are independent
    # builds, letting them run in parallel saves ~3 minutes.
    # ═══════════════════════════════════════════════════════

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build pkg-config \
            libgtk-4-dev libcurl4-openssl-dev libssl-dev \
            luajit libluajit-5.1-dev \
            libspdlog-dev nlohmann-json3-dev \
            wget file

      - name: Build
        working-directory: oss-executor
        run: |
          mkdir -p build && cd build
          cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr
          ninja -j$(nproc)

      - name: Create AppImage
        run: |
          # ── Download tools ──
          wget -q "https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage"
          wget -q "https://raw.githubusercontent.com/linuxdeploy/linuxdeploy-plugin-gtk/master/linuxdeploy-plugin-gtk.sh"
          chmod +x linuxdeploy-x86_64.AppImage linuxdeploy-plugin-gtk.sh

          # ── Populate AppDir ──
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/share/oss-executor

          cp oss-executor/build/OSSExecutor AppDir/usr/bin/
          cp -r oss-executor/scripts oss-executor/themes \
                oss-executor/resources oss-executor/config.json \
                AppDir/usr/share/oss-executor/

          # ── Desktop file (must have NO leading whitespace) ──
          cat > AppDir/usr/share/applications/oss-executor.desktop << 'DESKTOP_EOF'
          [Desktop Entry]
          Type=Application
          Name=OSS Executor
          Comment=Open Source Roblox Executor
          Exec=OSSExecutor
          Icon=oss-executor
          Categories=Development;
          Terminal=false
          DESKTOP_EOF

          # ── Icon ──
          if [ -f oss-executor/resources/icons/logo.png ]; then
            cp oss-executor/resources/icons/logo.png \
               AppDir/usr/share/icons/hicolor/256x256/apps/oss-executor.png
          else
            # Fallback: 1x1 transparent PNG (valid, won't crash)
            printf '\x89PNG\r\n\x1a\n' > \
               AppDir/usr/share/icons/hicolor/256x256/apps/oss-executor.png
          fi

          # ── AppRun wrapper with GIO/D-Bus isolation ──
          cat > AppDir/AppRun << 'APPRUN_EOF'
          #!/usr/bin/env bash
          SELF="$(readlink -f "$0")"
          HERE="$(dirname "$SELF")"
          export GIO_MODULE_DIR=""
          export GIO_USE_VFS="local"
          export GSK_RENDERER="${GSK_RENDERER:-gl}"
          export GTK_A11Y=none
          export NO_AT_BRIDGE=1
          if [ -z "${DBUS_SESSION_BUS_ADDRESS:-}" ]; then
              export DBUS_SESSION_BUS_ADDRESS="disabled:"
          fi
          export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH:-}"
          export OSS_HOME="${HOME}/.oss-executor"
          exec "${HERE}/usr/bin/OSSExecutor" "$@"
          APPRUN_EOF
          chmod +x AppDir/AppRun

          # ══════════════════════════════════════════════════
          # ██  FUSE FIX: CI runners lack /dev/fuse.         ██
          # ██  APPIMAGE_EXTRACT_AND_RUN=1 makes linuxdeploy ██
          # ██  extract to /tmp instead of FUSE-mounting.    ██
          # ══════════════════════════════════════════════════
          export APPIMAGE_EXTRACT_AND_RUN=1
          export DEPLOY_GTK_VERSION=4
          export OUTPUT="OSS_Executor-x86_64.AppImage"

          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --plugin gtk \
            --output appimage \
            --desktop-file AppDir/usr/share/applications/oss-executor.desktop \
            --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/oss-executor.png

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: oss-executor-AppImage
          path: "OSS_Executor-x86_64.AppImage"
          if-no-files-found: warn

      - name: Attach AppImage to Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: "OSS_Executor-x86_64.AppImage"
